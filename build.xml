<project name="BuildServer" default="selena" basedir="." xmlns:ivy="antlib:fr.jayasoft.ivy.ant">
  
  <property name="dest" value="c:/IDEA" />

  <taskdef uri="antlib:fr.jayasoft.ivy.ant"
           resource="fr/jayasoft/ivy/ant/antlib.xml">
    <classpath>
      <pathelement location="${basedir}/lib/ivy-1.4.1.jar"/>
      <pathelement location="${basedir}/lib/commons-httpclient-3.0.1.jar"/>
      <pathelement location="${basedir}/lib/commons-logging.jar"/>
      <pathelement location="${basedir}/lib/commons-codec-1.3.jar"/>
    </classpath>
  </taskdef>

 <target name="selena">
   <property name="ivy-conf-xml" value="${basedir}/ivy-selena.xml" />
   <antcall target="fetch" />
 </target>

 <target name="selena-pinned">
   <property name="ivy-conf-xml" value="${basedir}/ivy-selena-pinned.xml" />
   <antcall target="fetch" />
 </target>


  <target name="fetch" description="Retrieves artifacts for TeamCity">
    <delete dir="${basedir}/tools" failonerror="false" />
    <mkdir dir="${basedir}/tools"/>

    <property name="ivy-conf" value="default" />
  
    <condition property="teamcity.auth.userId" value="labs\builduser">
      <not>
        <isset property="${teamcity.auth.userId}"/>
      </not>
    </condition>

    <condition property="teamcity.auth.password" value="***REMOVED***">
      <not>
        <isset property="${teamcity.auth.password}"/>
      </not>
    </condition>

    <condition property="agent.work.dir" value=".."> <!-- Ivy cache will be put there -->
      <not>
        <isset property="${agent.work.dir}"/>
      </not>
    </condition>

    <ivy:configure file="${basedir}/ivyconf.xml"
                   host="buildserver.labs.intellij.net"
                   realm="TeamCity"
                   username="${teamcity.auth.userId}"
                   passwd="${teamcity.auth.password}"/>

    <ivy:resolve file="${ivy-conf-xml}" conf="${ivy-conf}" />

    <ivy:retrieve pattern="${basedir}/tools/[artifact].[ext]" conf="${ivy-conf}"/>

    <antcall target="gather"/>
    <antcall target="patch"/>
    <antcall target="replace"/>
    
    <delete dir="${basedir}/tools" failonerror="false" />
  </target>

  <target name="replace">
    <delete dir="${dest}.old" failonerror="false"/>
    <mkdir dir="${dest}.old"/>
   
    <move todir="${dest}.old">
      <fileset dir="${dest}" includes="**/*" />
    </move>

    <mkdir dir="${dest}"/>

    <move todir="${dest}"> 
      <fileset dir="${basedir}/bin" includes="**/*" />
    </move>
  </target>

  <target name="gather">
    <delete dir="${basedir}/bin" failonerror="false" />
    <mkdir dir="${basedir}/bin"/>

    <unzip dest="${basedir}/bin">
      <fileset dir="${basedir}/tools" includes="idea*.zip"/>
    </unzip>

    <copy todir="${basedir}/bin/lib" overwrite="true">
      <fileset dir="${basedir}/tools/idea.jar.unscrambled.16" includes="idea.jar" />
    </copy>
  </target>

  <target name="patch">
    <property name="opts" value="${basedir}/bin/bin/idea.exe.vmoptions"/>
    
    <replaceregexp file="${opts}" match="-Xmx\d+m" replace="-Xmx684m" flags="g" byline="true"/>
    <replaceregexp file="${opts}" match="-Xms\d+m" replace="-Xms192m" flags="g" byline="true"/>
    <replaceregexp file="${opts}" match="-XX:MaxPermSize=\d+m" replace="-XX:MaxPermSize=150m" flags="g" byline="true"/>
   
    <concat destfile="${basedir}/bin/bin/idea.exe.vmoptions" append="true">
-Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=5005</concat>   

    <copy file="${basedir}/run.bat" todir="${basedir}/bin" />
  </target>

</project>